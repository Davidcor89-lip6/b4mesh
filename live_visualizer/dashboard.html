<!doctype html>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<meta name="viewport" content="width=device-width, initial-scale=1">
<html>
    <title>Blockgraph live visualizer</title>
    <head>
        <link rel="icon" href="favicon.ico" />
        <link rel="stylesheet" href="style.css">
        <link rel="stylesheet" href="dashboardstyle.css">
        <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
        <script src="//d3js.org/d3.v5.min.js"></script>
        <script src="https://unpkg.com/@hpcc-js/wasm@0.3.11/dist/index.min.js"></script>
        <script src="https://unpkg.com/d3-graphviz@3.0.5/build/d3-graphviz.js"></script>
        <script src="scripts/json_to_dot_cluster.js"></script>
        <script src="scripts/json_to_dot_time.js"></script>
        <script src="scripts/string_hash.js"></script>
        <script src="scripts/view_operations.js"></script>
        <script src="configuration.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.js"></script>
        <link
          href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700&display=swap"
          rel="stylesheet"
        />    
        <script
        src="https://code.jquery.com/jquery-3.6.0.js"
        integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
        crossorigin="anonymous"></script>
    </head>
    <body>
        
        <main>
          <div class="header">
            <h1 class="title">B4MESH </h1>

          </div>
          <div class="menu"> 
            <ul class="links">
              <li class="link-container">
                <a class="menu-link"  href="#"> 
                  <svg 
                  aria-hidden="true" 
                  focusable="false" 
                  data-prefix="fas" 
                  data-icon="home" 
                  class="svg-inline--fa fa-home fa-w-18" 
                  role="img" 
                  xmlns="http://www.w3.org/2000/svg" 
                  viewBox="0 0 576 512">
                  <path fill="currentColor" 
                  d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path>
                </svg>
                <span>Home</span>
                </a>
              </li>
              <li class="link-container">
                <a class="menu-link" href="index.html">
                  <svg 
                  aria-hidden="true" 
                  focusable="false" 
                  data-prefix="far" 
                  data-icon="eye" 
                  class="svg-inline--fa fa-eye fa-w-18" 
                  role="img" 
                  xmlns="http://www.w3.org/2000/svg" 
                  viewBox="0 0 576 512">
                  <path fill="currentColor" 
                  d="M288 144a110.94 110.94 0 0 0-31.24 5 55.4 55.4 0 0 1 7.24 27 56 56 0 0 1-56 56 55.4 55.4 0 0 1-27-7.24A111.71 111.71 0 1 0 288 144zm284.52 97.4C518.29 135.59 410.93 64 288 64S57.68 135.64 3.48 241.41a32.35 32.35 0 0 0 0 29.19C57.71 376.41 165.07 448 288 448s230.32-71.64 284.52-177.41a32.35 32.35 0 0 0 0-29.19zM288 400c-98.65 0-189.09-55-237.93-144C98.91 167 189.34 112 288 112s189.09 55 237.93 144C477.1 345 386.66 400 288 400z"></path>
                  </svg>
                    <span >Visualisation</span>
                </a>
              </li>
              <li class="link-container">
                <a class="menu-link" href="#">
                  <svg
                    color="green"
                    version="1.1"
                    xmlns="http://www.w3.org/2000/svg"
                    xmlns:xlink="http://www.w3.org/1999/xlink"
                    x="0px"
                    y="0px"
                    viewBox="0 0 1000 1000"
                    enable-background="new 0 0 1000 1000"
                    xml:space="preserve"
                  >
                    <metadata>
                      Svg Vector Icons : http://www.onlinewebfonts.com/icon
                    </metadata>
                    <g>
                      <path
                        fill="currentColor"
                        d="M950.5,742.8c-113.5-0.5-227.1-0.3-340.6-0.3h-18c1.6,23.1,3.7,45.2,4.6,67.4c1.2,28.6,14.6,48.6,39.5,61.9c10.1,5.4,19.8,11.6,29.5,17.7c2.9,1.8,6,3.9,8,6.6c5.5,7.6,1.9,14.6-7.6,14.8c-14.7,0.3-29.3,0.1-44,0.1c-94.4,0-188.8,0-283.2-0.1c-5.5,0-12.5,1.7-14.4-5.8c-1.8-7.3,3.2-11.8,9-15.2c12.6-7.5,25.2-15,37.7-22.6c19.3-11.8,29.9-29,31.6-51.6c1.8-23.8,3.6-47.7,5.5-73.1h-12.4c-116.4,0-232.8,0-349.2,0c-25.4,0-36.6-11.2-36.6-36.8c0-180.2,0-401.2,0-581.4c0-23,11.8-35.1,34.5-35.1c302,0,604,0.1,906-0.3c18.8,0,32,5.8,39.5,23.2v607.4C982.5,736.9,969.3,742.9,950.5,742.8z M943.4,156.3H56.5v514.3h886.9V156.3z M117.2,520.2c0-11.4,0.1-22.9,0-34.4c-0.1-8.6,3.7-13.2,12.5-13.2c13,0,26.1,0.1,39.1,0c8.8-0.1,12.8,4.6,12.9,13c0.1,23.5,0.1,47.1,0,70.6c0,8.5-4.2,12.9-13,12.8c-12.7-0.1-25.5,0.1-38.2-0.1c-9.5-0.1-13.1-3.9-13.2-13.5C117.1,543.7,117.2,531.9,117.2,520.2L117.2,520.2z M302.9,503.9c0-16.6-0.1-33.1,0-49.7c0.1-10.2,3.5-13.6,13.8-13.7c12.4-0.1,24.8-0.1,37.3,0c9.6,0.1,13.4,3.6,13.4,13.3c0.2,34.1,0.1,68.1,0,102.2c0,8.4-4.2,13-13,12.9c-12.7-0.1-25.5,0.1-38.2-0.1c-9.5-0.1-13.2-3.9-13.3-13.4C302.8,538.3,302.9,521.1,302.9,503.9z M274.3,488.5c0,22,0.1,44,0,65.9c0,11.1-3.2,14.3-14.1,14.5c-12.1,0.1-24.2,0.1-36.3,0c-9.9-0.1-13.6-3.3-13.7-12.9c-0.2-44.9-0.2-89.8,0-134.8c0-9.7,3.7-12.9,13.6-13c12.4-0.1,24.9-0.1,37.3,0c9.6,0.1,13.1,3.7,13.1,13.4C274.4,443.9,274.3,466.2,274.3,488.5z M847.3,313.1c-40.2,30.1-79.9,59.9-120.8,90.5V248.5C763.1,244.9,825.9,278.2,847.3,313.1z M395.9,473.3c0-27.1,0-54.2,0-81.3c0-13.2,3.1-16.1,16.4-16.2c11.2,0,22.3-0.1,33.5,0c10.3,0.1,14.1,3.6,14.1,13.5c0.1,55.5,0.1,110.9,0,166.4c0,9.5-3.8,13-13.5,13.2c-12.4,0.2-24.9,0.1-37.3,0c-9.5-0.1-13.1-3.6-13.2-13.4C395.9,528.1,396,500.7,395.9,473.3L395.9,473.3z M334.4,371.8c29.9-34,59.5-67.6,90.8-103.1c-13.8,0-25.1-0.2-36.4,0.1c-7.6,0.2-13.5-1.9-14.2-10.5c-0.6-6.9,5-10.9,14.7-10.9c18.8,0,37.6-0.1,56.4,0c11,0.1,14.3,3.2,14.3,14.2c0.1,19.4-0.1,38.9,0.1,58.3c0.1,7.5-2.9,13-10.6,13c-7.7,0-10.9-5.3-10.8-12.9c0.1-10.4,0-20.8,0-33.8c-4.6,5-7.8,8.3-10.8,11.8c-27,30.6-53.9,61.3-80.9,91.8c-8.5,9.6-12.2,9.9-22.4,1.8c-27.2-21.6-54.3-43.3-82-65.5c-2.6,2.3-5.2,4.4-7.7,6.8c-31.1,29.3-62.2,58.5-93.3,87.8c-2.3,2.2-4.5,4.5-7.1,6.4c-5.1,3.7-11.2,3.8-14.2-1.5c-2-3.5-1-9.2-0.1-13.7c0.5-2.3,3.8-4.1,5.9-6.1c34.8-32.8,69.6-65.6,104.4-98.3c9.3-8.7,12.1-8.8,22-0.9c24.4,19.5,48.8,39,73.2,58.5C328.5,367.3,331.3,369.4,334.4,371.8z M814.3,549c-26.7-41.4-53.4-82.8-80.5-124.7c42.1-31.5,83.5-62.5,125-93.6C901,393.8,888,497.5,814.3,549z M704.8,260.3c0,31,0,61.2,0,91.5c0,19.1-0.3,38.3,0.2,57.4c0.1,4.8,1.5,10.1,4.1,14.1c23.7,37.4,47.9,74.5,71.8,111.7c2.9,4.5,5.8,9,8.7,13.5c-42.6,27.1-111.8,30.2-165.4-8.6c-54.5-39.4-77.6-108.7-57.4-172.2C586.2,306.4,644,261.1,704.8,260.3z"
                      />
                    </g>
                  </svg>
                <span>Dashboard</span>
                
                </a>
              </li>
            </ul>
          </div>
          

            
      <!-- Graph -->
      <div id="theGraphs">
      <div id="graph-container">
        <div class="toolbar-global">
          <div class="h100">

            <div class="card_top">
              Number of transactions in the blockgraph
                <div class="toolbar_element_solo">
                  <span class="information_value" id="transaction-global">0</span>
                </div>
            </div>
            
            
          </div> 
          <div class="chart-container">  
            <canvas id="totransaction" height="80"></canvas>
          </div>
        </div>
      </div>

      
            <div class="toolbar-global">
              <div class="h100">
                <div class="card_top">
                  Number of transaction in the node generated
                  <div class="toolbar_element_solo">
                    <span class="information_value" id="transaction-local">0</span>
                  </div>
                </div>
              </div> 
              <div class="chart-container">  
                <canvas id="canvas" height="80"></canvas>
              </div>
            </div>


        </div>
        <div id="theGraphs">
           <div id="graph-container">
          <div class="toolbar">
            <div class="h100">
  
              <div class="card_top">
                Transaction per second
               
              </div>
              
            </div> 
            <div class="chart-container">  
              <span class="information_value" id="transaction-psec">0</span>
            </div>
          </div>
           </div>



        <div id="graph-container">
          <div class="toolbar">
            <div class="h100">
  
              <div class="card_top">
                Time between blocks (s)
                
              </div>
              
            </div> 
            <div class="chart-container">  
              <span class="information_value" id="transaction-retransmission">0</span>
            </div>
          </div>
        </div>
  
  
        <div id="graph-container">
          <div class="toolbar">
            <div class="h100">
  
              <div class="card_top">
                Size of blockgraph (Kb)
               
              </div>
              
            </div> 
            <div class="chart-container">  
              <span class="information_value" id="transaction-lost">0</span>
            </div>
          </div>
        </div>
      </div>
        

      
    </div>  


      <div id="graph-container">
        <div class="memtoolbar">
          <div class="h100">

            <div class="card_top">
              Mempool usage of the node
              <div class="w3-light-grey w3-round-xlarge">
                <div class="w3-container w3-blue w3-round-xlarge" id=mempoolpourcent style="width:0%"><p id="pour"></p></div>
              </div>
            </div>
            
          </div> 
          <div class="chart-container">  
            <canvas id="mempoolusage" height="80"></canvas>
          </div>
        </div>
      </div>

      <div id="graph-container">
        <div class="memtoolbar">
          <div class="h100">
            <div class="card_top">
               Last transactions commited in the blockgraph
            </div>
          </div> 

          <table>
            
            <tr>
                <th scope="col">Transaction Position</th>
                <th scope="col">1</th>
                <th scope="col">2</th>
                <th scope="col">3</th>
                <th scope="col">4</th>
                <th scope="col">5</th>
                <th scope="col">6</th>
                <th scope="col">7</th>
                <th scope="col">8</th>
                <th scope="col">9</th>
                <th scope="col">10</th>
            
            </tr>
            <tr>
                <th scope="row">Hash</th>
                <td ><div id="h1"></div></td>
                <td ><div id="h2"></div></td>
                <td ><div id="h3"></div></td>
                <td ><div id="h4"></div></td>
                <td ><div id="h5"></div></td>
                <td ><div id="h6"></div></td>
                <td ><div id="h7"></div></td>
                <td ><div id="h8"></div></td>
                <td ><div id="h9"></div></td>
                <td ><div id="h10"></div></td>
            </tr>
            <tr>
                <th scope="row">Timestamp</th>
                <td ><div id="t1"></div></td>
                <td ><div id="t2"></div></td>
                <td ><div id="t3"></div></td>
                <td ><div id="t4"></div></td>
                <td ><div id="t5"></div></td>
                <td ><div id="t6"></div></td>
                <td ><div id="t7"></div></td>
                <td ><div id="t8"></div></td>
                <td ><div id="t9"></div></td>
                <td ><div id="t10"></div></td>
            </tr>
        </table>
        </div>
      </div>



    </div>


        </main>
        
        <script type="text/javascript">
        var chart;
        var hist;
        var mem;
        var retrans;
        var lotrans;
        var totrans



        function xhrSuccess() {
    this.callback.apply(this, this.arguments);
}

function xhrError() {
    console.error(this.statusText);
}

        function loadFile(url, callback /*, opt_arg1, opt_arg2, ... */) {
            var xhr = new XMLHttpRequest();
            xhr.callback = callback;
            xhr.arguments = Array.prototype.slice.call(arguments, 2);
            xhr.onload = xhrSuccess;
            xhr.onerror = xhrError;
            xhr.open("GET", url, true);
            xhr.send(null);
        }

        function creategraphTransaction(message) {
            creategraph(this.responseText);
        }

        function updateTransaction(message) {
            updateNumberofTransaction(this.responseText);
        }
        

        
        function creategraphMempool(message) {
            createMemPoolUsageGraph(this.responseText);
        }

        function updateMempool(message) {
            updateMempoolUsage(this.responseText);
        }
        function startcreatemempoolpourcent(data){
         createmempoolpourcent(this.responseText)
          
        }
        function updatepourcentMempool(message) {
            pourcentMempool(this.responseText);
        }

        function createReTransactiongraph(message) {
            createReTransaction(this.responseText);
        }

        function updatereTransactiongraph(message) {
            updateReTransaction(this.responseText);
        }


        function createLostTransactiongraph(message) {
            createLostTransaction(this.responseText);
        }

        function updateLostTransactiongraph(message) {
            updateLostTransaction(this.responseText);
        }

        function createTotTransactiongraph(message) {
            createTotTransaction(this.responseText);
        }

        function updateTotTransactiongraph(message) {
            updateTotTransaction(this.responseText);
        }

        function updateListTransactiongraph(message) {
         
            updateListTransaction(this.responseText);
        }




        // initialize number of transaction in the blockgraph
        function creategraph(data){
          var label=[];
          var values=[];
          var labelps=[];
          var valuesps=[];


          data=data.split("\n");
          data.pop()
          for( x=0; x<data.length;x++){
            data[x]=data[x].split(":");
            label.push(data[x][0]);
            values.push(data[x][1]);
            //graph per sec
            if(data[x][0]==0){
              labelps.push(data[x][0]);
              valuesps.push(data[x][1]);
              document.getElementById("transaction-psec").innerHTML=data[data.length-1][1];
            }else{
              labelps.push(data[x][0]);
              valuesps.push(data[x][1]/data[x][0]);
              document.getElementById("transaction-psec").innerHTML=(data[data.length-1][1]/data[x][0]).toFixed(2);
            }
            
          }


          var ctx = document.getElementById('canvas').getContext('2d');
          chart = new Chart(ctx, {
              type: 'line',
             
              data: {
                labels: label,
                datasets: [{
                    backgroundColor: 'rgb(129, 198, 2228)',
                    borderColor: 'rgb(0, 150, 215)',
                    data: values
                }]
              },
              options: {
                responsive: 'true',
              legend: {
                display: false
              },
              scales: {
                xAxes: [{
                  scaleLabel: {
                    display: true,
                    labelString: 'seconds'
                  }
                }]
              }
            }
          });



          
        }
        // initialize mempool usage graph
        function createMemPoolUsageGraph(data){
          var label=[];
          var values=[];
          
          data=data.split("\n");
          data.pop()
          for( x=0; x<data.length;x++){
            data[x]=data[x].split(":");
            label.push(data[x][0]);
            values.push(data[x][1]);
          }


          var ctx = document.getElementById('mempoolusage').getContext('2d');
          mem = new Chart(ctx, {
              type: 'line',
              data: {
                labels: label,
                datasets: [{
                    backgroundColor: 'rgb(129, 198, 2228)',
                    borderColor: 'rgb(0, 150, 215)',
                    data: values
                }]
              },
              options: {
                responsive: 'true',
              legend: {
                display: false
              },
              scales: {
                xAxes: [{
                  scaleLabel: {
                    display: true,
                    labelString: 'seconds'
                  }
                }],
                yAxes:[{
                  scaleLabel: {
                    display: true,
                    labelString: 'Kb'
                  }
                }]
              }
            }
          });
        }

        // inisialize number of transaction in the node and commited per seconds
        function createReTransaction(data){
          var label=[];
          var values=[];
          
          data=data.split("\n");
          data.pop()
          for( x=0; x<data.length;x++){
            data[x]=data[x].split(":");
            label.push(data[x][0]);
            values.push(data[x][1]);
          }
          document.getElementById("transaction-retransmission").innerHTML=data[data.length-1][1];

        }

         // inisialize size of the blockgraph
        function createLostTransaction(data){
          var label=[];
          var values=[];
          
          data=data.split("\n");
          data.pop()
          for( x=0; x<data.length;x++){
            data[x]=data[x].split(":");
            label.push(data[x][0]);
            values.push(data[x][1]);
          }

          document.getElementById("transaction-lost").innerHTML=data[data.length-1][1];
        }

        // inisialize number of transaction in the blockgraph
        function createTotTransaction(data){
          var label=[];
          var values=[];
          
          data=data.split("\n");
          data.pop()
          for( x=0; x<data.length;x++){
            data[x]=data[x].split(":");
            label.push(data[x][0]);
            values.push(data[x][1]);
          }


          var ctx = document.getElementById('totransaction').getContext('2d');
          totrans = new Chart(ctx, {
              type: 'line',
              data: {
                labels: label,
                datasets: [{
                    backgroundColor: 'rgb(129, 198, 2228)',
                    borderColor: 'rgb(0, 150, 215)',
                    data: values
                }]
              },
              options: {
                responsive: 'true',
              legend: {
                display: false
              },
              scales: {
                xAxes: [{
                  scaleLabel: {
                    display: true,
                    labelString: 'seconds'
                  }
                }]
              }
            }
          });
        }
        
        

        
        function resetCanvas(){
          $('#canvas').remove();
          $('#graph-container').append('<canvas id="canvas"><canvas>');
        }
        
        // initialize every metrics of the dashboard
        loadFile("tests/datas/tmp/transactions", creategraphTransaction);
        loadFile("tests/datas/tmp/Mempool", creategraphMempool);
        loadFile("tests/datas/tmp/Pourcentmempool", startcreatemempoolpourcent)
        

        loadFile("tests/datas/tmp/retransactions", createReTransactiongraph);
        loadFile("tests/datas/tmp/losttransactions", createLostTransactiongraph);
        loadFile("tests/datas/tmp/totaltransa", createTotTransactiongraph);

     
        // update every metrics of the dashboard
        var intervalId = window.setInterval(function(){
            loadFile("tests/datas/tmp/Mempool", updateMempool);
            loadFile("tests/datas/tmp/transactions", updateTransaction);
    
            loadFile("tests/datas/tmp/Pourcentmempool", updatepourcentMempool)
            loadFile("tests/datas/tmp/retransactions", updatereTransactiongraph);
            loadFile("tests/datas/tmp/losttransactions", updateLostTransactiongraph);
            loadFile("tests/datas/tmp/totaltransa", updateTotTransactiongraph);
            loadFile("tests/datas/tmp/listtransa", updateListTransactiongraph);
            
        }, 2000);

        //Functions for updating differents metrics evry x seconds


        // update node transaction commited and transaction commited per second
        function updateNumberofTransaction(data){
         
          data=data.split("\n");
          
          data.pop()
          linemissing=data.length-chart.data.labels.length;
          if (linemissing==0){
            
          }
          else if(linemissing>0){
            
            for (index=0; index < linemissing; index++) {
              console.log(chart.data.labels.length)
              x=data[chart.data.labels.length+index].split(":");
              chart.data.labels.push(x[0]);
              chart.data.datasets[0].data.push(x[1]);
              chart.update();
              //graph per sec
              
            }
            
            hist.update();
          }
         
          x=data[data.length-1].split(":")
          document.getElementById("transaction-local").innerHTML=x[1];
          if(data[0]==0){
               
               document.getElementById("transaction-psec").innerHTML=x[1];
             }else{
              
               document.getElementById("transaction-psec").innerHTML=(x[1]/x[0]).toFixed(2);
             }
             console.log(data.length-1)
        }


        // updtate mempool usage graph
        function updateMempoolUsage(data){

          data=data.split("\n");
          
          data.pop()
          linemissing=data.length-mem.data.labels.length;
          if (linemissing==0){
            
          }
          else if(linemissing>0){
            
            for (index=0; index < linemissing; index++) {
              x=data[mem.data.labels.length+index].split(":");
              mem.data.labels.push(x[0]);
              mem.data.datasets[0].data.push(x[1]);
              mem.update();
            }
          }
          
        }

        //create pourcentage bar value
        function createmempoolpourcent(data){
          data=data.split("\n");
          pourcent=data[data.length - 2];
          document.getElementById("pour").innerHTML = pourcent;
          document.getElementById("mempoolpourcent").style.width = pourcent;
        }

        // update pourcentage bar value
        function pourcentMempool(data){

          data=data.split("\n");
          pourcent=data[data.length - 2];
          document.getElementById("pour").innerHTML = pourcent;
          document.getElementById("mempoolpourcent").style.width = pourcent;
        }


        //update mean block time creation value
        function updateReTransaction(data){

          data=data.split("\n");

          data.pop()
        
          x=data[data.length-1].split(":")
          document.getElementById("transaction-retransmission").innerHTML=x[1];

        }


        // update blockgraph size value
        function updateLostTransaction(data){

         
          data=data.split("\n");
          
          data.pop()
          x=data[data.length-1].split(":")
          document.getElementById("transaction-lost").innerHTML=x[1];

        }


        // update number of transaction in the blockgraph
        function updateTotTransaction(data){

          data=data.split("\n");
          data.pop()
          linemissing=data.length-totrans.data.labels.length;
          if (linemissing==0){
            
          }
          else if(linemissing>0){
            
            for (index=0; index < linemissing; index++) {
              x=data[totrans.data.labels.length+index].split(":");
              totrans.data.labels.push(x[0]);
              totrans.data.datasets[0].data.push(x[1]);
              totrans.update();
            }
          }
          x=data[data.length-1].split(":")
          document.getElementById("transaction-global").innerHTML=x[1];

        }

        // update table of the last  10 transaction in the blockgraph
        function updateListTransaction(data){
          data=data.split("\n");
          data.pop();
            
            for (index=0; index < 10; index++) {
            
              x=data[(data.length) -index -1].split(":");
              var h= "h"+(index+1);
              var t= "t"+(index+1);
              document.getElementById(h).innerHTML=x[0];
              document.getElementById(t).innerHTML=x[1];
            }
          }
        

        

        </script>
    </body>
</html>