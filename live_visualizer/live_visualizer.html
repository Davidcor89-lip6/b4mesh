<!doctype html>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<html>
    <title>Blockgraph live visualizer</title>
    <head>
        <link rel="icon" href="favicon.ico" />
        <link rel="stylesheet" href="style.css">
        <script src="//d3js.org/d3.v5.min.js"></script>
        <script src="https://unpkg.com/@hpcc-js/wasm@0.3.11/dist/index.min.js"></script>
        <script src="https://unpkg.com/d3-graphviz@3.0.5/build/d3-graphviz.js"></script>
        <script src="scripts/json_to_dot.js"></script>
    </head>
    <body>
        <p style="width: 100%;">
            Blockgraph live visualizer
        </p>
        <div id="graph-container" style="width: 100%; height: 600px; margin:auto; border: 1px solid black"></div>
        
        <script type="text/javascript">

            if (!window.Worker)
                console.log('[error](polling) Browser does not support workers')

            const graphContainer = d3.select("#graph-container");
            var transition = d3.transition()
                .duration(750)
                .ease(d3.easeLinear);
            var rendering = graphContainer
                .graphviz()
                .transition(transition)
                .width(graphContainer.node().clientWidth)
                .height(graphContainer.node().clientHeight)
                .fit(true)
                .zoom(true);

            var render_graph = function(datas) {
                rendering.renderDot(datas);
            }
            window.onresize = function() {
                console.log('window resized to [' + window.innerWidth + 'x' + window.innerHeight + ']');
                rendering
                .width(graphContainer.node().clientWidth)
                .height(graphContainer.node().clientHeight)
                .fit(true)
                .render();
            };

            var worker = function(){
                // fix Chrome security error (Firefox allow local files, not Chrome)
                const poll_worker_task_URL = function() {
                    var url = new URL(window.location.href);
                    url.search = "";
                    url.pathname = "scripts/poll_worker_task.js";
                    return url;
                }();
                return new Worker(poll_worker_task_URL.toString());
            }();

            String.prototype.hashCode = function() {
                var hash = 0, i, chr;
                if (this.length === 0) return hash;
                for (i = 0; i < this.length; i++) {
                    chr   = this.charCodeAt(i);
                    hash  = ((hash << 5) - hash) + chr;
                    hash |= 0; // Convert to 32bit integer
                }
                return hash;
            };

            var previous_datas_hashcode = 0;
            worker.onmessage = function(event) {

                if (document.hidden)
                {
                    console.log('Tab is not focused, canceling datas update ...')
                    return; // do not update if the tab is inactive
                }
                const current_datas_hashcode = event.data.hashCode();
                if (current_datas_hashcode == previous_datas_hashcode)
                {
                    console.log('polled same datas, canceling datas update ...')
                    return; // do not update if datas already rendered
                }
                previous_datas_hashcode = event.data.hashCode();

                // console.log("worker.onmessage ... [" + event.data + "]")

                var datas_as_dot = null;
                try { datas_as_dot = json_to_dot(event.data); }
                catch (error) {
                    console.error('[error](rendering) graph rendering failed : ' + error)
                    throw(error);
                }

                try {
                    render_graph(datas_as_dot);
                }
                catch (error) { console.error('[error](rendering) graph rendering failed : ' + error) }
            };
            worker.onerror = function(event){
                console.log("[error](polling) worker error : " + event.message);
            };
        </script>
    </body>
</html>